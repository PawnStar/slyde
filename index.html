<!doctype html>
<html>
  <head>
    <title>Slyde</title>
    <style>
      .slide-container{
        display:none;
      }
      #currentSlide{
        display:block;
      }
      .notes{
        display:none;
      }
    </style>
  </head>
  <body>
    <div id="presentationFrame">
      <div class="slide-container" id="currentSlide">
        <h1>Slide 1</h1>
        <span class="notes">
          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent rutrum metus et odio rutrum sodales at eget neque. Phasellus faucibus, augue vitae varius porta, magna est vestibulum nunc, at ullamcorper lorem risus quis nisl. Nullam tempus elit ac enim mollis, et molestie erat vehicula. Duis dignissim ipsum eu pharetra molestie. Morbi in tempus diam. Curabitur finibus lobortis velit, bibendum varius lacus ultricies non. Donec a felis viverra, malesuada erat dictum, scelerisque magna. Nunc a rhoncus urna. Nam quis tellus quis velit porttitor dictum non sed sapien. Maecenas egestas dignissim dapibus. Cras sit amet blandit nisl. Curabitur viverra vehicula congue. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Nulla ac velit sed ex facilisis molestie vel vitae risus.</p>
          <p>Suspendisse sollicitudin eleifend justo, ac interdum risus tincidunt id. Curabitur a purus porta, dictum lorem vel, varius nulla. Duis facilisis lectus nec imperdiet maximus. Phasellus accumsan, mi vitae ornare dignissim, dolor erat tincidunt erat, a ultrices justo erat eget nibh. Vivamus ultricies auctor risus, vitae dictum dui posuere et. Aenean accumsan tellus eu est elementum laoreet vel quis augue. Mauris mattis ex nec sem consequat, vel volutpat velit facilisis. Phasellus euismod dignissim sapien, eget pharetra urna convallis id. Curabitur arcu purus, finibus non ex condimentum, ullamcorper elementum justo. Donec fringilla lacus blandit, dictum massa sed, consectetur elit. Nullam ac blandit diam, ut luctus ligula. In venenatis nulla in sem pharetra, et feugiat lorem efficitur. Nunc et nulla at diam maximus laoreet.</p>
          <p>Curabitur sit amet dignissim justo. Proin et iaculis ante. Cras quis blandit mi. Pellentesque consequat suscipit lacus nec viverra. Fusce pretium nulla et magna fringilla hendrerit. Cras vehicula finibus condimentum. Duis tristique in mi in semper. Pellentesque et molestie ex. Nulla neque orci, consectetur quis tempus in, consectetur id nisi. Sed varius elit ex, et facilisis dolor auctor a. In bibendum eros vitae sapien condimentum commodo. Praesent eget efficitur ex, vel porta augue. In mi nulla, volutpat id lacus ut, porttitor ornare urna.</p>
          <p>Morbi imperdiet turpis a purus ultricies molestie. Fusce id cursus sem, ut cursus metus. Integer nec nisi libero. Praesent vel ultricies felis. Nulla ut viverra nulla, ut rhoncus justo. Aenean scelerisque massa vel pretium mollis. Aenean quis eros in est venenatis sollicitudin.</p>
          <p>Maecenas eros felis, molestie ut ante sed, semper dignissim neque. Quisque nec faucibus ligula, ut eleifend tortor. Maecenas tempor urna justo, nec condimentum lorem tincidunt in. Donec accumsan diam elit, eget interdum neque pellentesque vel. Cras eu finibus orci, a rhoncus turpis. Nam a lorem id nisi commodo sodales. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut suscipit volutpat nibh, id scelerisque lectus porttitor in. Sed varius viverra vulputate. Suspendisse maximus lacinia orci vitae consequat. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae;</p>
        </span>
      </div>
      <div class="slide-container">
        <h1>Slide 2</h1>
        <span class="notes">Notes for the second slide</span>
      </div>
      <div class="slide-container">
        <h1>Slide 3</h1>
        <span class="notes">Notes for the third slide</span>
      </div>
      <div class="slide-container">
        <h1>Slide 4</h1>
        <span class="notes">Notes for the fourth slide</span>
      </div>
      <div class="slide-container">
        <h1>Slide 5</h1>
        <span class="notes">Notes for the final slide</span>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var current = null;
      var containerId = 'presentationFrame';
      var selectedId = 'currentSlide';

      $(document).ready(function(){
        console.log('starting')
        var socket = io();
        //Retry if necessary
        socket.on('register', function(){
          console.log('Being asked to register');
          var key;
          if(!window.location.hash)
            key = getSemiRandID(6);
          else
            key = window.location.hash
          console.log("Trying: " + key);
          socket.emit('register', key);
        })
        socket.on('re-register', function(){
          console.log("Being asked to register again");
          var key = getSemiRandID(6);
          console.log("Trying: " + key);
          socket.emit('register', key);
        })
        socket.on('registered', function(id){
          console.log("Successfully registerd " + id);
          window.location.hash = id;
          sendCurrentNotes(socket);
        })

        //Move forward when instructed
        socket.on('move-next', function(){
          transitionNext();
          sendCurrentNotes(socket);
        })

        //Move backward when instructed
        socket.on('move-prev', function(){
          transitionPrev();
          sendCurrentNotes(socket);
        })

        socket.on('request-notes', function(){
          sendCurrentNotes(socket);
        })
      })

      function getSemiRandID(length){
        var scope = '2346789ABCDEFGHJKLMNPQRSTUVWXYZ'; //Omitting some of the tricker pairs (1/I) etc

        var result = '#';
        for(var i = length; i > 0; --i)
          result += scope[Math.floor(Math.random() * scope.length)];
        return result;
      }

      function transitionNext(){
        current = document.getElementById(selectedId);
      	if(current.nextElementSibling != null){
          console.log('Transitioning to next');
          current.removeAttribute('id');
          current.nextElementSibling.id = selectedId;
      	}else{
      		console.log('Returning to beginning');
      		var all = document.getElementById(containerId).getElementsByClassName('slide-container');
      		var first = document.getElementById(containerId).firstElementChild;
          current.removeAttribute('id');
      		first.id = selectedId;
      	}
      }

      function transitionPrev(){
        current = document.getElementById(selectedId);
      	if(current.previousElementSibling != null){
          console.log('Transitioning to prev');
          current.removeAttribute('id');
          current.previousElementSibling.id = selectedId;
      	}else{
      		console.log('Jumping to end');
      		var all = document.getElementById(containerId).getElementsByClassName('slide-container');
      		var last = document.getElementById(containerId).lastElementChild;
          current.removeAttribute('id');
      		last.id = selectedId;
      	}
      }

      function sendCurrentNotes(socket){
        if($('#' + selectedId + ' span.notes').length)
          socket.emit('update-notes', {id: window.location.hash, notes: $('#' + selectedId + ' span.notes').html()})
        else
          socket.emit('update-notes', {id: window.location.hash, notes: 'No notes available'})
      }

    </script>
  </body>
</html>
